name: Spring Boot - Deploy to GKE- V5

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: spring-boot-test-app
  GKE_ZONE: asia-southeast1-a          # fixed correct zone name
  DEPLOYMENT_NAME: spring-boot-test-app
  IMAGE: spring-boot-test-app
  AR_LOCATION: asia                         # choose closest: us, europe, asia
  REPO_NAME: gcr.io                         # keeps your old image path working

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        run: mvn test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/
          retention-days: 14

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    # Only run on push to main (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: 'read'
      id-token: 'write'                     # Needed for workload identity (recommended)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build JAR
        run: mvn clean package -DskipTests -B

      # ────── AUTHENTICATE USING WORKLOAD IDENTITY (2025 BEST PRACTICE) ──────
      # No more storing full SA keys! Much more secure.
      - name: Authenticate to Google Cloud (Workload Identity)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker asia-docker.pkg.dev,${{ env.AR_LOCATION && format('-{0}', env.AR_LOCATION) }}

      # ────── BUILD & PUSH IMAGE ──────
      - name: Build and Push Docker Image
        run: |
          IMAGE_PATH=${{ env.AR_LOCATION }}-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE
          
          docker build -t $IMAGE_PATH:$GITHUB_SHA \
                       -t $IMAGE_PATH:latest .

          docker push $IMAGE_PATH:$GITHUB_SHA
          docker push $IMAGE_PATH:latest

      # ────── DEPLOY TO GKE ──────
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --zone $GKE_ZONE --project $PROJECT_ID

      - name: Deploy to GKE
        run: |
          IMAGE=${{ env.AR_LOCATION }}-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE:$GITHUB_SHA
          
          kubectl set image deployment/$DEPLOYMENT_NAME \
            spring-boot-app=$IMAGE
          
          kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=300s
          
          echo "Deployment successful!"
          kubectl get pods -l app=spring-boot-app
          kubectl get svc spring-boot-service -o wide

      - name: Show external URL
        run: |
          echo "External IP/URL:"
          kubectl get svc spring-boot-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'